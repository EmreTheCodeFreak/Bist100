<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIST Test</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
        .log { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; max-height: 400px; overflow-y: auto; }
        .log-item { padding: 8px; margin: 4px 0; border-radius: 4px; font-size: 13px; }
        .success { background: #d1f4e0; color: #0e8345; }
        .error { background: #ffd9d9; color: #c41e3a; }
        .info { background: #e7f3ff; color: #1e40af; }
        button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .result { background: white; padding: 15px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª BIST Hata Testi</h1>
    <button onclick="runTest()">Test BaÅŸlat</button>
    <div class="log" id="log"></div>
    <div id="results"></div>

    <script>
        const RAPIDAPI_KEY = 'a6b421a13cmshfff258d85702407p19ef6fjsn0e60e66f9b71';
        const testStocks = ['GARAN', 'THYAO', 'AKBNK', 'EREGL', 'SAHOL'];

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const item = document.createElement('div');
            item.className = `log-item ${type}`;
            item.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logDiv.appendChild(item);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        async function testBIST() {
            log('1ï¸âƒ£ BIST API test ediliyor...', 'info');
            try {
                const response = await fetch('https://bist100-stock-data-15-minutes-late-live.p.rapidapi.com/bist100/prices', {
                    headers: {
                        'x-rapidapi-host': 'bist100-stock-data-15-minutes-late-live.p.rapidapi.com',
                        'x-rapidapi-key': RAPIDAPI_KEY
                    }
                });
                
                log(`BIST Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const text = await response.text();
                    log(`BIST Hata: ${text}`, 'error');
                    return null;
                }
                
                const data = await response.json();
                log(`âœ… BIST baÅŸarÄ±lÄ±! ${Object.keys(data).length} hisse bulundu`, 'success');
                
                // Ä°lk 5 hisseyi gÃ¶ster
                testStocks.forEach(symbol => {
                    if (data[symbol]) {
                        log(`  ${symbol}: â‚º${data[symbol].price}`, 'success');
                    } else {
                        log(`  ${symbol}: BULUNAMADI!`, 'error');
                    }
                });
                
                return data;
            } catch (error) {
                log(`âŒ BIST Hata: ${error.message}`, 'error');
                return null;
            }
        }

        async function testYahoo(symbol) {
            log(`2ï¸âƒ£ Yahoo API test ediliyor: ${symbol}...`, 'info');
            try {
                const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/stock/v3/get-chart?interval=1d&symbol=${symbol}.IS&range=1y&region=US`;
                const response = await fetch(url, {
                    headers: {
                        'x-rapidapi-host': 'apidojo-yahoo-finance-v1.p.rapidapi.com',
                        'x-rapidapi-key': RAPIDAPI_KEY
                    }
                });
                
                log(`Yahoo Response Status: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const text = await response.text();
                    log(`Yahoo Hata: ${text}`, 'error');
                    return null;
                }
                
                const data = await response.json();
                const chart = data.chart?.result?.[0];
                
                if (!chart) {
                    log(`âŒ ${symbol}: Chart verisi yok!`, 'error');
                    log(`DÃ¶nen veri: ${JSON.stringify(data).substring(0, 200)}`, 'error');
                    return null;
                }
                
                const quote = chart.indicators?.quote?.[0];
                if (!quote) {
                    log(`âŒ ${symbol}: Quote verisi yok!`, 'error');
                    return null;
                }
                
                const close = quote.close?.filter(v => v != null) || [];
                log(`âœ… ${symbol}: ${close.length} gÃ¼nlÃ¼k veri`, close.length >= 200 ? 'success' : 'error');
                
                return { close, high: quote.high, low: quote.low, volume: quote.volume };
            } catch (error) {
                log(`âŒ Yahoo Hata (${symbol}): ${error.message}`, 'error');
                return null;
            }
        }

        async function runTest() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            
            log('ğŸš€ Test baÅŸlatÄ±lÄ±yor...', 'info');
            
            // 1. BIST Test
            const bistData = await testBIST();
            if (!bistData) {
                log('âŒ BIST baÅŸarÄ±sÄ±z! Test durduruluyor.', 'error');
                return;
            }
            
            await new Promise(r => setTimeout(r, 1000));
            
            // 2. Yahoo Test (sadece 1 hisse)
            const yahooData = await testYahoo('GARAN');
            if (!yahooData) {
                log('âŒ Yahoo baÅŸarÄ±sÄ±z! Test durduruluyor.', 'error');
                return;
            }
            
            log('', 'info');
            log('ğŸ‰ TÃœM TESTLER BAÅARILI!', 'success');
            log('Ana uygulama Ã§alÄ±ÅŸmalÄ±. EÄŸer Ã§alÄ±ÅŸmÄ±yorsa, lÃ¼tfen bu log\'u gÃ¶nderin.', 'info');
            
            // SonuÃ§larÄ± gÃ¶ster
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="result">
                    <h3>âœ… Test SonuÃ§larÄ±</h3>
                    <p><strong>BIST API:</strong> Ã‡alÄ±ÅŸÄ±yor (${Object.keys(bistData).length} hisse)</p>
                    <p><strong>Yahoo API:</strong> Ã‡alÄ±ÅŸÄ±yor (${yahooData.close.length} gÃ¼nlÃ¼k veri)</p>
                    <p><strong>GARAN Fiyat:</strong> â‚º${bistData.GARAN?.price}</p>
                    <p><strong>SonuÃ§:</strong> Sistem Ã§alÄ±ÅŸÄ±r durumda!</p>
                </div>
            `;
        }
    </script>
</body>
</html>