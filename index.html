<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>BIST 100 Pro Analiz</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); min-height: 100vh; padding-bottom: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 16px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 100; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .header h1 { font-size: 22px; font-weight: 700; color: #1d1d1f; }
        .header-info { font-size: 11px; color: #86868b; }
        .header-info .live { color: #10b981; font-weight: 600; }
        .btn { padding: 10px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .btn:active { transform: scale(0.96); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 60px 20px; color: white; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { background: rgba(255, 255, 255, 0.2); height: 8px; border-radius: 10px; margin: 20px auto; max-width: 80%; overflow: hidden; }
        .progress-fill { background: white; height: 100%; border-radius: 10px; transition: width 0.3s; }
        .filters { display: flex; gap: 8px; overflow-x: auto; padding: 12px 16px; scrollbar-width: none; }
        .filters::-webkit-scrollbar { display: none; }
        .chip { padding: 8px 16px; background: rgba(255, 255, 255, 0.25); color: white; border-radius: 20px; font-size: 13px; font-weight: 600; white-space: nowrap; border: none; cursor: pointer; transition: all 0.2s; }
        .chip.active { background: white; color: #667eea; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .sort-buttons { display: flex; gap: 8px; padding: 0 16px 12px; }
        .sort-btn { padding: 6px 12px; background: rgba(255, 255, 255, 0.2); color: white; border-radius: 10px; font-size: 12px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .sort-btn.active { background: white; color: #667eea; }
        .results-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; }
        .results-header h2 { font-size: 18px; font-weight: 700; color: white; }
        .count-badge { background: rgba(255, 255, 255, 0.25); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; }
        .stocks { padding: 0 16px; }
        .stock-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        .stock-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .stock-title { display: flex; align-items: center; gap: 8px; }
        .stock-name { font-size: 20px; font-weight: 700; color: #1d1d1f; }
        .fav-btn { background: none; border: none; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
        .stock-recommendation { font-size: 14px; font-weight: 600; margin-top: 4px; }
        .stock-price { font-size: 18px; font-weight: 700; text-align: right; color: #10b981; }
        .stock-score { font-size: 24px; font-weight: 700; text-align: right; }
        .ema-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 12px; }
        .ema-box { background: #f5f5f7; padding: 8px 4px; border-radius: 8px; text-align: center; }
        .ema-label { font-size: 10px; color: #86868b; font-weight: 600; margin-bottom: 4px; }
        .ema-value { font-size: 11px; font-weight: 700; color: #1d1d1f; }
        .indicators { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .indicator-tag { padding: 6px 10px; border-radius: 8px; font-size: 11px; font-weight: 600; }
        .ind-green { background: #d1f4e0; color: #0e8345; }
        .ind-red { background: #ffd9d9; color: #c41e3a; }
        .ind-yellow { background: #fff4cc; color: #996600; }
        .recommendations { background: #f5f5f7; padding: 12px; border-radius: 12px; }
        .rec-title { font-size: 13px; font-weight: 700; color: #1d1d1f; margin-bottom: 8px; }
        .rec-item { margin-bottom: 6px; font-size: 12px; line-height: 1.4; }
        .rec-label { font-weight: 700; }
        .rec-short { color: #ef4444; }
        .rec-medium { color: #f59e0b; }
        .rec-long { color: #3b82f6; }
        .rec-detail { color: #666; font-size: 11px; margin-left: 4px; }
        .empty-state { text-align: center; padding: 60px 20px; color: white; }
        .empty-icon { font-size: 64px; margin-bottom: 16px; }
        .info-box { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; padding: 16px; margin: 16px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); }
        .info-box h3 { font-size: 16px; font-weight: 700; color: #1d1d1f; margin-bottom: 12px; }
        .info-box p { font-size: 12px; color: #1d1d1f; line-height: 1.6; margin-bottom: 8px; }
        .error-box { background: #ffd9d9; border: 2px solid #c41e3a; color: #c41e3a; padding: 16px; margin: 16px; border-radius: 12px; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [stocks, setStocks] = useState([]);
            const [filteredStocks, setFilteredStocks] = useState([]);
            const [favorites, setFavorites] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [lastBistUpdate, setLastBistUpdate] = useState(null);
            const [activeChip, setActiveChip] = useState('all');
            const [sortBy, setSortBy] = useState('score');
            const [progress, setProgress] = useState(0);

            const RAPIDAPI_KEY = 'a6b421a13cmshfff258d85702407p19ef6fjsn0e60e66f9b71';
            const FAVORITES_KEY = 'bist_favorites';

            const bistStocks = ['GARAN', 'THYAO', 'KCHOL', 'AKBNK', 'EREGL', 'SAHOL', 'PETKM', 'TUPRS', 'SISE', 'TCELL', 'ASELS', 'BIMAS', 'ISCTR', 'KOZAL', 'VAKBN', 'SODA', 'FROTO', 'TOASO', 'HALKB', 'ENKAI', 'ARCLK', 'TAVHL', 'YKBNK', 'PGSUS', 'MGROS', 'TTKOM', 'OYAKC', 'KONTR', 'DOHOL', 'VESBE', 'AEFES', 'EKGYO', 'ODAS', 'TTRAK', 'AGHOL', 'ALARK', 'ZOREN', 'CIMSA', 'SNGYO', 'GESAN', 'ULKER', 'OTKAR', 'TSKB', 'IPEKE', 'LOGO', 'GOODY', 'HEKTS', 'SKBNK', 'MPARK', 'KLMSN', 'BRSAN', 'BUCIM', 'DOAS', 'BJKAS', 'IEYHO', 'CEMTS', 'CRFSA', 'BRISA', 'MAVI', 'BIOEN', 'YATAS', 'ACSEL', 'ULUUN', 'BFREN', 'KRDMD', 'TKFEN', 'ALCTL', 'IZMDC', 'TMSN', 'ISGYO', 'DESA', 'MRSHL', 'ATSYH', 'ANSGR', 'IZOCM', 'KARSN', 'FENER', 'NETAS', 'AFYON', 'SKTAS', 'TUKAS', 'ADEL', 'ARENA', 'AVOD', 'AYEN', 'BANVT', 'BTCIM', 'CELHA', 'CUSAN', 'DAGI', 'DYOBY', 'EGGUB', 'EPLAS', 'ERBOS', 'GEDZA', 'GENTS', 'GOLTS', 'GSDHO', 'INDES'];

            useEffect(() => {
                const saved = localStorage.getItem(FAVORITES_KEY);
                if (saved) setFavorites(JSON.parse(saved));
            }, []);

            const toggleFavorite = (symbol) => {
                const newFavorites = favorites.includes(symbol) 
                    ? favorites.filter(f => f !== symbol)
                    : [...favorites, symbol];
                setFavorites(newFavorites);
                localStorage.setItem(FAVORITES_KEY, JSON.stringify(newFavorites));
            };

            const getStockCacheKey = (symbol) => `yahoo_${symbol}`;
            const getTodayKey = () => new Date().toDateString();

            const getStockCache = (symbol) => {
                try {
                    const cached = localStorage.getItem(getStockCacheKey(symbol));
                    if (!cached) return null;
                    const data = JSON.parse(cached);
                    if (data.date !== getTodayKey()) {
                        localStorage.removeItem(getStockCacheKey(symbol));
                        return null;
                    }
                    return data.value;
                } catch { return null; }
            };

            const setStockCache = (symbol, data) => {
                try {
                    localStorage.setItem(getStockCacheKey(symbol), JSON.stringify({ date: getTodayKey(), value: data }));
                } catch {}
            };

            const fetchAllBistPrices = async () => {
                try {
                    const response = await fetch('https://bist100-stock-data-15-minutes-late-live.p.rapidapi.com/bist100/prices', {
                        headers: {
                            'x-rapidapi-host': 'bist100-stock-data-15-minutes-late-live.p.rapidapi.com',
                            'x-rapidapi-key': RAPIDAPI_KEY
                        }
                    });
                    if (!response.ok) return null;
                    return await response.json();
                } catch { return null; }
            };

            const fetchYahooData = async (symbol) => {
                try {
                    const url = `https://apidojo-yahoo-finance-v1.p.rapidapi.com/stock/v3/get-chart?interval=1d&symbol=${symbol}.IS&range=1y&region=US`;
                    const response = await fetch(url, {
                        headers: {
                            'x-rapidapi-host': 'apidojo-yahoo-finance-v1.p.rapidapi.com',
                            'x-rapidapi-key': RAPIDAPI_KEY
                        }
                    });
                    if (!response.ok) return null;
                    const data = await response.json();
                    const chart = data.chart?.result?.[0];
                    if (!chart) return null;
                    const quote = chart.indicators?.quote?.[0];
                    if (!quote) return null;
                    return { close: quote.close, high: quote.high, low: quote.low, volume: quote.volume };
                } catch { return null; }
            };

            const calculateEMA = (data, period) => {
                if (!data || data.length < period) return null;
                const k = 2 / (period + 1);
                let ema = data.slice(0, period).reduce((a, b) => a + b, 0) / period;
                for (let i = period; i < data.length; i++) { ema = data[i] * k + ema * (1 - k); }
                return ema;
            };

            const calculateRSI = (data, period = 14) => {
                if (!data || data.length < period + 1) return null;
                let gains = 0, losses = 0;
                for (let i = data.length - period; i < data.length; i++) {
                    const change = data[i] - data[i - 1];
                    if (change > 0) gains += change; else losses -= change;
                }
                const avgGain = gains / period, avgLoss = losses / period;
                if (avgLoss === 0) return 100;
                return 100 - (100 / (1 + avgGain / avgLoss));
            };

            const calculateMACD = (data) => {
                if (!data || data.length < 26) return null;
                const ema12 = calculateEMA(data, 12), ema26 = calculateEMA(data, 26), macdLine = ema12 - ema26;
                const macdValues = [];
                for (let i = 26; i < data.length; i++) {
                    const slice = data.slice(0, i + 1);
                    macdValues.push(calculateEMA(slice, 12) - calculateEMA(slice, 26));
                }
                const signal = calculateEMA(macdValues, 9);
                return { macd: macdLine, signal, histogram: macdLine - signal };
            };

            const calculateBollingerBands = (data, period = 20) => {
                if (!data || data.length < period) return null;
                const slice = data.slice(-period);
                const sma = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((sum, val) => sum + Math.pow(val - sma, 2), 0) / period;
                const stdDev = Math.sqrt(variance);
                return { upper: sma + (stdDev * 2), middle: sma, lower: sma - (stdDev * 2) };
            };

            const calculateStochastic = (high, low, close, period = 14) => {
                if (!high || high.length < period) return null;
                const highSlice = high.slice(-period), lowSlice = low.slice(-period), currentClose = close[close.length - 1];
                const highestHigh = Math.max(...highSlice), lowestLow = Math.min(...lowSlice);
                if (highestHigh === lowestLow) return 50;
                return ((currentClose - lowestLow) / (highestHigh - lowestLow)) * 100;
            };

            const calculateADX = (high, low, close, period = 14) => {
                if (!high || high.length < period + 1) return null;
                let plusDM = 0, minusDM = 0, tr = 0;
                for (let i = close.length - period; i < close.length; i++) {
                    const highDiff = high[i] - high[i - 1], lowDiff = low[i - 1] - low[i];
                    plusDM += highDiff > lowDiff && highDiff > 0 ? highDiff : 0;
                    minusDM += lowDiff > highDiff && lowDiff > 0 ? lowDiff : 0;
                    tr += Math.max(high[i] - low[i], Math.abs(high[i] - close[i - 1]), Math.abs(low[i] - close[i - 1]));
                }
                if (tr === 0) return 0;
                const plusDI = (plusDM / tr) * 100, minusDI = (minusDM / tr) * 100;
                if (plusDI + minusDI === 0) return 0;
                return Math.abs(plusDI - minusDI) / (plusDI + minusDI) * 100;
            };

            const calculateRTI = (data, volume) => {
                if (!data || data.length < 20) return null;
                const recentData = data.slice(-20);
                const priceChange = ((recentData[recentData.length - 1] - recentData[0]) / recentData[0]) * 100;
                const volatility = Math.abs(priceChange);
                const avgVolume = volume.slice(-20).reduce((a, b) => a + b, 0) / 20;
                const volumeRatio = volume[volume.length - 1] / avgVolume;
                return Math.min(50 + (volatility * 5) + (volumeRatio * 10), 100);
            };

            const getSignal = (value, type) => {
                if (type === 'rsi') return value < 30 ? { signal: 'buy', color: 'green', text: 'A≈üƒ±rƒ± Satƒ±m' } : value > 70 ? { signal: 'sell', color: 'red', text: 'A≈üƒ±rƒ± Alƒ±m' } : { signal: 'neutral', color: 'yellow', text: 'N√∂tr' };
                if (type === 'macd') return value > 0 ? { signal: 'buy', color: 'green', text: 'Pozitif' } : { signal: 'sell', color: 'red', text: 'Negatif' };
                if (type === 'stochastic') return value < 20 ? { signal: 'buy', color: 'green', text: 'A≈üƒ±rƒ± Satƒ±m' } : value > 80 ? { signal: 'sell', color: 'red', text: 'A≈üƒ±rƒ± Alƒ±m' } : { signal: 'neutral', color: 'yellow', text: 'N√∂tr' };
                if (type === 'adx') return value > 25 ? { signal: 'buy', color: 'green', text: 'G√º√ßl√º Trend' } : value < 20 ? { signal: 'neutral', color: 'yellow', text: 'Zayƒ±f Trend' } : { signal: 'neutral', color: 'yellow', text: 'Orta' };
                if (type === 'rti') return value > 65 ? { signal: 'buy', color: 'green', text: 'G√º√ßl√º' } : value < 45 ? { signal: 'sell', color: 'red', text: 'Zayƒ±f' } : { signal: 'neutral', color: 'yellow', text: 'Orta' };
                return { signal: 'neutral', color: 'yellow', text: 'Bilinmiyor' };
            };

            const getEMASignal = (price, ema9, ema21, ema50) => {
                const above = (price > ema9 && ema9 > ema21 && ema21 > ema50);
                const below = (price < ema9 && ema9 < ema21 && ema21 < ema50);
                if (above) return { signal: 'buy', color: 'green', text: 'Y√ºkseli≈ü Trendi' };
                if (below) return { signal: 'sell', color: 'red', text: 'D√º≈ü√º≈ü Trendi' };
                return { signal: 'neutral', color: 'yellow', text: 'Karƒ±≈üƒ±k' };
            };

            const getBollingerSignal = (price, bb) => {
                if (price < bb.lower) return { signal: 'buy', color: 'green', text: 'Alt Banda Yakƒ±n' };
                if (price > bb.upper) return { signal: 'sell', color: 'red', text: '√úst Banda Yakƒ±n' };
                return { signal: 'neutral', color: 'yellow', text: 'Bantlar Arasƒ±' };
            };

            const calculateScore = (indicators) => {
                let buySignals = 0, total = 0;
                Object.values(indicators).forEach(ind => { if (ind?.signal) { total++; if (ind.signal === 'buy') buySignals++; } });
                if (total === 0) return { score: 50, recommendation: 'Veri Yetersiz' };
                const score = (buySignals / total) * 100;
                return { score: score.toFixed(0), recommendation: score >= 70 ? 'G√ú√áL√ú ALIM' : score >= 55 ? 'ALIM' : score >= 45 ? 'N√ñTR' : score >= 30 ? 'SATIM' : 'G√ú√áL√ú SATIM' };
            };

            const getRecommendations = (indicators, price, ema9, ema21, ema50, ema100, ema200) => {
                const rsi = indicators.rsi?.value;
                const stoch = indicators.stochastic?.value;
                const macd = indicators.macd?.value;
                const adx = indicators.adx?.value;
                const rti = indicators.rti?.value;

                // KISA VADELƒ∞ (1-7 g√ºn)
                let shortTerm = { signal: 'neutral', text: 'BEKLEYƒ∞N', reason: '' };
                if (rsi < 30 && stoch < 20) {
                    shortTerm = { signal: 'buy', text: 'ALIM', reason: `RSI ${rsi?.toFixed(1)} ve Stochastic ${stoch?.toFixed(1)} a≈üƒ±rƒ± satƒ±mda` };
                } else if (rsi > 70 && stoch > 80) {
                    shortTerm = { signal: 'sell', text: 'SATIM', reason: `RSI ${rsi?.toFixed(1)} ve Stochastic ${stoch?.toFixed(1)} a≈üƒ±rƒ± alƒ±mda` };
                } else if (rsi < 35) {
                    shortTerm = { signal: 'buy', text: 'ALIM', reason: `RSI ${rsi?.toFixed(1)} d√º≈ü√ºk seviyelerde` };
                } else if (rsi > 65 && macd < 0) {
                    shortTerm = { signal: 'sell', text: 'SATIM', reason: `RSI y√ºksek, MACD negatif` };
                } else {
                    shortTerm = { signal: 'neutral', text: 'BEKLEYƒ∞N', reason: 'Net sinyal yok' };
                }

                // ORTA VADELƒ∞ (1-4 hafta)
                let mediumTerm = { signal: 'neutral', text: 'BEKLEYƒ∞N', reason: '' };
                if (price > ema9 && ema9 > ema21 && ema21 > ema50 && adx > 25) {
                    mediumTerm = { signal: 'buy', text: 'ALIM', reason: `G√º√ßl√º y√ºkseli≈ü trendi, ADX ${adx?.toFixed(1)}` };
                } else if (price < ema9 && ema9 < ema21 && ema21 < ema50) {
                    mediumTerm = { signal: 'sell', text: 'SATIM', reason: 'D√º≈ü√º≈ü trendi' };
                } else if (indicators.bollinger?.signal === 'buy' && macd > 0) {
                    mediumTerm = { signal: 'buy', text: 'ALIM', reason: 'Bollinger alt banda yakƒ±n, MACD pozitif' };
                } else if (indicators.ema?.signal === 'buy') {
                    mediumTerm = { signal: 'buy', text: 'ALIM', reason: 'EMA dizilimi olumlu' };
                } else if (indicators.ema?.signal === 'sell') {
                    mediumTerm = { signal: 'sell', text: 'SATIM', reason: 'EMA dizilimi olumsuz' };
                } else {
                    mediumTerm = { signal: 'neutral', text: 'BEKLEYƒ∞N', reason: 'Trend belirsiz' };
                }

                // UZUN VADELƒ∞ (1-6 ay)
                let longTerm = { signal: 'neutral', text: 'N√ñTR', reason: '' };
                if (price > ema100 && price > ema200 && ema100 > ema200) {
                    longTerm = { signal: 'buy', text: 'ALIM', reason: 'EMA 100 ve 200 √ºzerinde, uzun vade y√ºkseli≈ü' };
                } else if (price < ema100 && price < ema200 && ema100 < ema200) {
                    longTerm = { signal: 'sell', text: 'SATIM', reason: 'EMA 100 ve 200 altƒ±nda, uzun vade d√º≈ü√º≈ü' };
                } else if (price > ema200) {
                    longTerm = { signal: 'buy', text: 'ALIM', reason: 'EMA 200 √ºzerinde' };
                } else if (price < ema200) {
                    longTerm = { signal: 'neutral', text: 'N√ñTR', reason: 'EMA 200 altƒ±nda ama momentum karƒ±≈üƒ±k' };
                } else {
                    longTerm = { signal: 'neutral', text: 'N√ñTR', reason: 'Uzun vade belirsiz' };
                }

                return { shortTerm, mediumTerm, longTerm };
            };

            const analyzeAllStocks = async () => {
                setLoading(true); setError(null); setProgress(0);

                console.log('üìä BIST API √ßaƒürƒ±lƒ±yor (1 istek)...');
                const bistPrices = await fetchAllBistPrices();
                setLastBistUpdate(new Date());

                const analyzedStocks = [];
                let yahooCallCount = 0, cacheHitCount = 0;

                for (let i = 0; i < bistStocks.length; i++) {
                    const symbol = bistStocks[i];
                    setProgress(((i + 1) / bistStocks.length) * 100);

                    try {
                        const bistPrice = bistPrices?.[symbol]?.price;
                        if (!bistPrice) continue;

                        let yahooData = getStockCache(symbol);
                        
                        if (!yahooData) {
                            console.log(`üîç Yahoo API: ${symbol}`);
                            yahooData = await fetchYahooData(symbol);
                            yahooCallCount++;
                            if (yahooData) setStockCache(symbol, yahooData);
                            await new Promise(resolve => setTimeout(resolve, 250));
                        } else {
                            cacheHitCount++;
                        }

                        if (!yahooData?.close) continue;

                        const close = yahooData.close.filter(v => v != null);
                        const high = yahooData.high.filter(v => v != null);
                        const low = yahooData.low.filter(v => v != null);
                        const volume = yahooData.volume.filter(v => v != null);
                        if (close.length < 200) continue;

                        const ema9 = calculateEMA(close, 9), ema21 = calculateEMA(close, 21), ema50 = calculateEMA(close, 50), ema100 = calculateEMA(close, 100), ema200 = calculateEMA(close, 200);
                        const rsi = calculateRSI(close), macd = calculateMACD(close), bb = calculateBollingerBands(close), stochastic = calculateStochastic(high, low, close), adx = calculateADX(high, low, close), rti = calculateRTI(close, volume);

                        const indicators = {
                            rsi: rsi ? { value: rsi, ...getSignal(rsi, 'rsi') } : null,
                            macd: macd ? { value: macd.histogram, ...getSignal(macd.histogram, 'macd') } : null,
                            stochastic: stochastic ? { value: stochastic, ...getSignal(stochastic, 'stochastic') } : null,
                            adx: adx ? { value: adx, ...getSignal(adx, 'adx') } : null,
                            rti: rti ? { value: rti, ...getSignal(rti, 'rti') } : null,
                            ema: getEMASignal(bistPrice, ema9, ema21, ema50),
                            bollinger: bb ? { value: bistPrice, ...getBollingerSignal(bistPrice, bb) } : null
                        };

                        const scoreData = calculateScore(indicators);
                        const recommendations = getRecommendations(indicators, bistPrice, ema9, ema21, ema50, ema100, ema200);

                        analyzedStocks.push({ name: symbol, price: bistPrice, ema9, ema21, ema50, ema100, ema200, indicators, score: scoreData.score, recommendation: scoreData.recommendation, recommendations });
                    } catch {}
                }

                console.log(`‚úÖ Tamamlandƒ±! Yahoo: ${yahooCallCount} √ßaƒürƒ±, Cache: ${cacheHitCount} hit`);
                
                if (analyzedStocks.length === 0) setError('Hi√ßbir hisse analiz edilemedi.');
                setStocks(analyzedStocks); setFilteredStocks(analyzedStocks); setLoading(false); setProgress(100);
            };

            useEffect(() => { analyzeAllStocks(); }, []);

            const handleQuickFilter = (filterType) => {
                setActiveChip(filterType);
                let filtered = [...stocks];
                if (filterType === 'favorites') filtered = filtered.filter(s => favorites.includes(s.name));
                else if (filterType === 'strong-buy') filtered = filtered.filter(s => s.score >= 70);
                else if (filterType === 'buy') filtered = filtered.filter(s => s.score >= 55 && s.score < 70);
                else if (filterType === 'oversold') filtered = filtered.filter(s => s.indicators.rsi?.value < 30);
                else if (filterType === 'overbought') filtered = filtered.filter(s => s.indicators.rsi?.value > 70);
                setFilteredStocks(filtered);
            };

            const handleSort = (type) => {
                setSortBy(type);
                let sorted = [...filteredStocks];
                if (type === 'score') sorted.sort((a, b) => b.score - a.score);
                else if (type === 'name') sorted.sort((a, b) => a.name.localeCompare(b.name));
                else if (type === 'price') sorted.sort((a, b) => b.price - a.price);
                setFilteredStocks(sorted);
            };

            const getScoreColor = (score) => score >= 70 ? '#10b981' : score >= 55 ? '#3b82f6' : score >= 45 ? '#f59e0b' : score >= 30 ? '#f97316' : '#ef4444';

            return (
                <div>
                    <div className="header">
                        <div className="header-top">
                            <div><h1>üìä BIST 100 Pro</h1></div>
                            <button className="btn" onClick={analyzeAllStocks} disabled={loading}>{loading ? '‚è≥' : 'üîÑ'}</button>
                        </div>
                        <div className="header-info">
                            <div className="live">üü¢ Fiyatlar: {lastBistUpdate ? lastBistUpdate.toLocaleTimeString('tr-TR') : '-'}</div>
                            <div>‚≠ê Favoriler: {favorites.length} hisse</div>
                        </div>
                    </div>
                    {error && <div className="error-box">‚ö†Ô∏è {error}</div>}
                    {loading && (
                        <div className="loading">
                            <div className="loading-spinner"></div>
                            <h2>Analiz Ediliyor...</h2>
                            <p>%{Math.round(progress)} tamamlandƒ±</p>
                            <div className="progress-bar"><div className="progress-fill" style={{width: `${progress}%`}}></div></div>
                        </div>
                    )}
                    {!loading && stocks.length > 0 && (
                        <>
                            <div className="filters">
                                {[{id: 'all', label: 'üìä T√ºm√º'}, {id: 'favorites', label: '‚≠ê Favoriler'}, {id: 'strong-buy', label: 'üü¢ G√º√ßl√º Alƒ±m'}, {id: 'buy', label: '‚úÖ Alƒ±m'}, {id: 'oversold', label: 'üìâ A≈üƒ±rƒ± Satƒ±m'}, {id: 'overbought', label: 'üìà A≈üƒ±rƒ± Alƒ±m'}].map(chip => (
                                    <button key={chip.id} className={`chip ${activeChip === chip.id ? 'active' : ''}`} onClick={() => handleQuickFilter(chip.id)}>{chip.label}</button>
                                ))}
                            </div>
                            <div className="sort-buttons">
                                {[{id: 'score', label: '‚≠ê Skor'}, {id: 'name', label: 'üî§ ƒ∞sim'}, {id: 'price', label: 'üí∞ Fiyat'}].map(sort => (
                                    <button key={sort.id} className={`sort-btn ${sortBy === sort.id ? 'active' : ''}`} onClick={() => handleSort(sort.id)}>{sort.label}</button>
                                ))}
                            </div>
                            <div className="results-header"><h2>Sonu√ßlar</h2><span className="count-badge">{filteredStocks.length} / {stocks.length}</span></div>
                            <div className="stocks">
                                {filteredStocks.map((stock, idx) => (
                                    <div key={idx} className="stock-card">
                                        <div className="stock-header">
                                            <div className="stock-title">
                                                <div className="stock-name">{stock.name}</div>
                                                <button className="fav-btn" onClick={() => toggleFavorite(stock.name)}>
                                                    {favorites.includes(stock.name) ? '‚≠ê' : '‚òÜ'}
                                                </button>
                                            </div>
                                            <div><div className="stock-price">‚Ç∫{stock.price?.toFixed(2)}</div><div className="stock-score" style={{ color: getScoreColor(stock.score) }}>{stock.score}</div></div>
                                        </div>
                                        <div className="stock-recommendation" style={{ color: getScoreColor(stock.score), marginBottom: '12px' }}>{stock.recommendation}</div>
                                        <div className="ema-grid">
                                            {[{label: 'EMA9', value: stock.ema9}, {label: 'EMA21', value: stock.ema21}, {label: 'EMA50', value: stock.ema50}, {label: 'EMA100', value: stock.ema100}, {label: 'EMA200', value: stock.ema200}].map((ema, i) => (
                                                <div key={i} className="ema-box"><div className="ema-label">{ema.label}</div><div className="ema-value">{ema.value ? `‚Ç∫${ema.value.toFixed(1)}` : '-'}</div></div>
                                            ))}
                                        </div>
                                        <div className="indicators">
                                            {Object.entries(stock.indicators).map(([key, ind]) => {
                                                if (!ind) return null;
                                                const colorClass = ind.color === 'green' ? 'ind-green' : ind.color === 'red' ? 'ind-red' : 'ind-yellow';
                                                const icon = ind.signal === 'buy' ? 'üü¢' : ind.signal === 'sell' ? 'üî¥' : 'üü°';
                                                const value = ind.value !== undefined ? ` ${ind.value.toFixed(1)}` : '';
                                                return <div key={key} className={`indicator-tag ${colorClass}`}>{icon} {key.toUpperCase()}:{value} - {ind.text}</div>;
                                            })}
                                        </div>
                                        <div className="recommendations">
                                            <div className="rec-title">üí° √ñneriler</div>
                                            <div className="rec-item">
                                                <span className="rec-label rec-short">‚ö° Kƒ±sa Vade:</span> {stock.recommendations.shortTerm.text}
                                                <span className="rec-detail">({stock.recommendations.shortTerm.reason})</span>
                                            </div>
                                            <div className="rec-item">
                                                <span className="rec-label rec-medium">üìä Orta Vade:</span> {stock.recommendations.mediumTerm.text}
                                                <span className="rec-detail">({stock.recommendations.mediumTerm.reason})</span>
                                            </div>
                                            <div className="rec-item">
                                                <span className="rec-label rec-long">üìà Uzun Vade:</span> {stock.recommendations.longTerm.text}
                                                <span className="rec-detail">({stock.recommendations.longTerm.reason})</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {filteredStocks.length === 0 && <div className="empty-state"><div className="empty-icon">üòï</div><h3>Sonu√ß Bulunamadƒ±</h3></div>}
                            </div>
                            <div className="info-box">
                                <h3>üí° √ñneri Sistemi</h3>
                                <p><strong>‚ö° Kƒ±sa Vade (1-7 g√ºn):</strong> RSI, Stochastic, anlƒ±k momentum</p>
                                <p><strong>üìä Orta Vade (1-4 hafta):</strong> EMA trendleri, Bollinger, ADX</p>
                                <p><strong>üìà Uzun Vade (1-6 ay):</strong> EMA 100/200, genel trend</p>
                                <p><strong>‚≠ê Favoriler:</strong> Yƒ±ldƒ±za tƒ±klayarak favori ekle/√ßƒ±kar</p>
                            </div>
                        </>
                    )}
                </div>
            );
        }
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>